<!-- @@master  = ../../_layout.html-->
<!-- @@block  =  jsBottom-->
<include src="../../_articles-js.html"></include>

<!-- @@close-->
<!-- @@block  =  css-->
<include src="../../_articles-css.html"></include>

<!-- @@close-->
<!-- @@block  =  articles-social-->
<include src="../../_articles-social.html"></include>

<!-- @@close-->
<!-- @@block  =  articles-footer-->
<include src="../../_articles.html"></include>

<!-- @@close-->
<!-- @@block  =  meta-->
<meta property="article:published_time" content="2015-09-15T00:10:00+01:00">

<meta name="keywords" content="svg,d3,d3js,zoom,zoom behavior">

<meta name="description" content="上一篇我們提到了拖拉行為 Drag Behavior，但在視覺畫圖表的世界裡，如果只有拖拉好像還是不夠的，因此 d3.js 也很貼心的設計了「縮放行為」( Zoom Behavior )，讓我們可以透過例如滑鼠滾輪滾動或手指的手勢，就可以進行圖表的縮放，這篇也將要來探討是如何實作的。">

<meta itemprop="name" content="SVG D3.js - 縮放行為 ( Zoom Behavior ) - OXXO.STUDIO">

<meta itemprop="image" content="http://www.oxxostudio.tw/img/articles/201509/rticles/201509/20150915_1_01b.jpg">

<meta itemprop="description" content="上一篇我們提到了拖拉行為 Drag Behavior，但在視覺畫圖表的世界裡，如果只有拖拉好像還是不夠的，因此 d3.js 也很貼心的設計了「縮放行為」( Zoom Behavior )，讓我們可以透過例如滑鼠滾輪滾動或手指的手勢，就可以進行圖表的縮放，這篇也將要來探討是如何實作的。">

<meta property="og:title" content="SVG D3.js - 縮放行為 ( Zoom Behavior ) - OXXO.STUDIO">

<meta property="og:url" content="http://www.oxxostudio.tw/articles/201509/svg-d3-17-zoom-behavior.html" target="_blank">

<meta property="og:image" content="http://www.oxxostudio.tw/img/articles/201509/rticles/201509/20150915_1_01b.jpg">

<meta property="og:description" content="上一篇我們提到了拖拉行為 Drag Behavior，但在視覺畫圖表的世界裡，如果只有拖拉好像還是不夠的，因此 d3.js 也很貼心的設計了「縮放行為」( Zoom Behavior )，讓我們可以透過例如滑鼠滾輪滾動或手指的手勢，就可以進行圖表的縮放，這篇也將要來探討是如何實作的。">

<title>SVG D3.js - 縮放行為 ( Zoom Behavior ) - OXXO.STUDIO</title> 

<!-- @@close-->
<!-- @@block  =  articles-content--> 
<h2>SVG D3.js - 縮放行為 ( Zoom Behavior ) <span class="article-date" tag="web">SEP 15, 2015</span></h2>
<p><img src="/img/articles/201509/20150915_1_01.jpg" class="preview-img"></p>
<p>上一篇我們提到了<a href="http://www.oxxostudio.tw/articles/201509/svg-d3-16-drag-behavior.html">拖拉行為 Drag Behavior</a>，但在視覺化圖表的世界裡，如果只有拖拉好像還是不夠的，因此 d3.js 也很貼心的設計了「縮放行為」( Zoom Behavior )，讓我們可以透過例如滑鼠滾輪滾動或手指的手勢，就可以進行圖表的縮放，這篇也將要來探討是如何實作的，畢竟縮放的效果在 web 領域是比較少見也比較不容易實做，而 d3.js 與 svg 的結合，讓這個效果可以輕鬆愜意的展現。</p>
<p>zoom 的用法和 drag 滿類似的，都是一開始要先用<code>d3.behavior.zoom();</code>宣告行為，然後再使用<code>call</code>來呼叫，不過 zoom 相對又稍微複雜了些，因為又多了一些參數需要設定，讓我們先來看一下它提供了哪些 api：</p>
<blockquote>
<ul>
<li>zoom.translate([translate])：移動距離，預設為(0,0)</li>
<li>zoom.scale([scale])：縮放大小比例，預設為(1)</li>
<li>zoom.scaleExtent([extent])：縮放最大值與最小值，預設為(1,無限大)</li>
<li>zoom.center([center])：預設值為 null，縮放中心點，會以滑鼠指標位置為中心點</li>
<li>zoom.x([x])：預設值為 null，指定縮放時，應自動調整其域 x 縮放比例</li>
<li>zoom.y([y])：預設值為 null，指定縮放時，應自動調整其域 y 縮放比例</li>
<li>zoom.on(type, listener)：提供「zoomstart」、「zoom」和「zoomend」的監聽事件</li>
<li>zoom.event(selection)：執行當下事件</li>
</ul>
</blockquote>
<p><br/></p>
<p>雖然都列出來，不過預設值為 null 的 center、x 和 y 看了許多範例也沒有看到相關的用法，難怪會預設為 null 了，可能之後做得比較複雜會用到也不一定，所以這三個就不在這篇介紹，這篇主要來介紹「基本的縮放」、「點選放大」以及「reset 回原本尺寸」的實作。</p>
<p>首先我們先用 d3.js 來放入 svg，設定長寬，並給予一個邊框。( 如果不知道怎麼使用的，可以參考我之前的<a href="http://www.oxxostudio.tw/list.html">文章</a>，在標題搜尋輸入「d3」 )</p>
<pre><code>var w = 800;
var h = 400;

var svg = d3.select(&#39;body&#39;)
.append(&#39;svg&#39;)
.attr({
  &#39;width&#39;:&#39;100%&#39;,
  &#39;height&#39;:&#39;100%&#39;
}).style({
  &#39;border&#39;:&#39;1px solid #000&#39;
});
</code></pre><p><br/></p>
<p>接著在 svg 裏頭放入一個變數名為 container 的群組 g，把要縮放的東西全都丟進去裡面，首先要丟進去的是垂直和水平的灰線，這裡我用了<code>d3.range</code>來快速畫線，<code>d3.range</code>有三個屬性，第一個和第二個是範圍，第三個是中間自動產生的數值的間距，由我的設定可以看出，假設 0 到 w 是 300，每 30 做一個區分，所以 x 方向會有 11 個數字產生，而 y 方向也是一樣的做法，由此我們便可以由這些數字畫出對應的線條了。</p>
<pre><code>var container = svg.append(&#39;g&#39;);

container.append(&#39;g&#39;)
  .selectAll(&#39;line&#39;)
  .data(d3.range(0, w, 30))
  .enter()
  .append(&#39;line&#39;)
  .attr({
    &#39;x1&#39;: function(d) { return d; },
    &#39;y1&#39;: 0,
    &#39;x2&#39;: function(d) { return d; },
    &#39;y2&#39;: h,
    &#39;stroke&#39;:&#39;#ddd&#39;,
    &#39;fill&#39;:&#39;none&#39;
  });

container.append(&#39;g&#39;)
  .selectAll(&#39;line&#39;)
  .data(d3.range(0, h, 30))
  .enter()
  .append(&#39;line&#39;)
  .attr({
    &#39;x1&#39;: 0,
    &#39;y1&#39;: function(d) { return d; },
    &#39;x2&#39;: w,
    &#39;y2&#39;: function(d) { return d; },
    &#39;stroke&#39;:&#39;#ddd&#39;,
    &#39;fill&#39;:&#39;none&#39;
  });
</code></pre><p><br/></p>
<p>再來就是在畫面上放入一些圓球，這裏直接用一個 data 的陣列來產生這些球，也因為這些球也要縮放，所以同樣放在 container 裡頭。</p>
<pre><code>var data = [
  {&#39;cx&#39;:150, &#39;cy&#39;:210, &#39;r&#39;:50, &#39;fill&#39;:&#39;#ff0000&#39;},
  {&#39;cx&#39;:75, &#39;cy&#39;:55, &#39;r&#39;:40, &#39;fill&#39;:&#39;#00cc00&#39;},
  {&#39;cx&#39;:200, &#39;cy&#39;:30, &#39;r&#39;:30, &#39;fill&#39;:&#39;#0000ff&#39;},
  {&#39;cx&#39;:650, &#39;cy&#39;:190, &#39;r&#39;:70, &#39;fill&#39;:&#39;#0099cc&#39;},
  {&#39;cx&#39;:300, &#39;cy&#39;:200, &#39;r&#39;:30, &#39;fill&#39;:&#39;#ff9900&#39;}
];

container.append(&quot;g&quot;).selectAll(&#39;circle&#39;)
  .data(data)
  .enter()
  .append(&#39;circle&#39;)
  .attr({
    &#39;cx&#39;: function(d){return d.cx;},
    &#39;cy&#39;: function(d){return d.cy;},
    &#39;r&#39;: function(d){return d.r;},
    &#39;fill&#39;: function(d){return d.fill;}
  })
  .style({
    &#39;cursor&#39;:&#39;pointer&#39;
  });
</code></pre><p><br/></p>
<p>如果沒有意外，完成後的長相應該會像下圖這樣，不過還不能縮放，因為我們還沒有寫 zoom 的程式進去。( 範例：<a href="/demo/201509/svg-d3-17-zoom-behavior-demo01.html">svg-d3-17-zoom-behavior-demo01.html</a> )</p>
<p><img src="/img/articles/201509/20150915_1_02.jpg" alt="SVG D3.js - 縮放行為 ( Zoom Behavior )"></p>
<p>再來就是要針對 SVG 加入 zoom 的行為，我們先新增三個全域變數 x、y、s，作為紀錄縮放改變大小的位置偏移量以及縮放尺寸，如此一來我們「要縮回去原本大小的時候，就有一個參考的準則」，接著設置一個 zoom 的行為，一開始的 translate 設為 0,0，也就是會對齊左上角，scaleExtent 設為 [1,10]，最大值鎖定在 10 倍大，預設的 scale 設為 1，然後寫一下在 zoom 發生時要執行的 function，重點在利用<code>d3.event.translate</code>獲取當下的偏移量，用<code>d3.event.scale</code>獲得當下的縮放比例，最後設置新的偏移量以及尺寸。( 在這裡不用煩惱滑鼠與座標的轉換，因為在 d3.event 裏頭已經幫我們算好了 )</p>
<p>然後最重要的，在剛剛的 svg 後方加入 call，呼叫 zoom 的行為，到這個步驟，打開範例我們已經可以用滑鼠的滾輪，或是手勢來進行縮放了。
( 範例：<a href="/demo/201509/svg-d3-17-zoom-behavior-demo02.html">svg-d3-17-zoom-behavior-demo02.html</a> )</p>
<pre><code>var x,y,s;

var zoom = d3.behavior.zoom()
    .translate([0, 0])
    .scaleExtent([1, 10])
    .scale(1)
    .on(&quot;zoom&quot;, zoomed);

function zoomed() {
  x=d3.event.translate[0];
  y=d3.event.translate[1];
  s=d3.event.scale;
  container.attr(&quot;transform&quot;, &quot;translate(&quot; + d3.event.translate + &quot;) scale(&quot; + d3.event.scale + &quot;)&quot;);
}

var svg = d3.select(&#39;body&#39;)
.append(&#39;svg&#39;)
.attr({
  &#39;width&#39;:&#39;100%&#39;,
  &#39;height&#39;:&#39;100%&#39;
}).style({
  &#39;border&#39;:&#39;1px solid #000&#39;
})
.call(zoom);
</code></pre><p><br/></p>
<p>接著，我在畫面裡頭放上一個 id 為 reset 的按鈕，目的在於點選這個按鈕的時候，不論今天我把畫面縮放到如何，都會恢復為預設的大小和位置，當然因為是按鈕，會有「click」事件，直接用 d3.js 提供的 on api 就可以，不過如果只有恢復原本的大小，畫面就會是跳動的，不會有中間的補間動畫，因此這裡我利用之前提過的「<a href="http://www.oxxostudio.tw/articles/201509/svg-d3-15-transition-tween.html">tween</a>」，來加入補間動畫，由於要從現在縮放的大小跑到預設值，就必須要用到一開始的全域變數 s、x 和 y，最後呼叫<code>zoom.event</code>，就可以很流暢的恢復到原本的大小。</p>
<pre><code>d3.select(&#39;#reset&#39;).on(&#39;click&#39;,function(){
  d3.transition().duration(250).tween(&quot;zoom&quot;, function() {
    var si = d3.interpolate(s, 1);
    var xi = d3.interpolate(x, 0);
    var yi = d3.interpolate(y, 0);
    return function(t){
      svg.call(zoom.translate([xi(t),yi(t)]).scale(si(t)).event);
    }
  });
});
</code></pre><p><br/></p>
<p>但只有這樣子我還不滿足，應該還要加上一個點選圓形就會放大的效果，所以我們在每個圓形上都加上 click 事件，利用<code>getAttribute</code>獲得圓心座標，然後利用<code>(w-r)/2-4*cx</code>或<code>(h-r)/2-4*cy</code>的簡單數學計算讓放大的時候圓心會置中 ( 放大四倍就乘四 )，最後同樣用搭配<code>tween</code>和<code>zoom.event</code>就可以完成點擊放大的效果。</p>
<pre><code>d3.selectAll(&#39;circle&#39;).on(&#39;click&#39;,function(){
  var circle = d3.select(this);
  circle.transition().duration(250).tween(&quot;zoom&quot;, function() {
    var r = this.getAttribute(&#39;r&#39;)*1;
    var cx = this.getAttribute(&#39;cx&#39;)*1;
    var cy = this.getAttribute(&#39;cy&#39;)*1;
    var si = d3.interpolate(s, 4);
    var xi = d3.interpolate(x, (w-r)/2-4*cx);
    var yi = d3.interpolate(y, (h-r)/2-4*cy);
    return function(t){
      svg.call(zoom.translate([xi(t),yi(t)]).scale(si(t)).event);
    }
  });
});
</code></pre><p>最後最後，我們加上一段<code>svg.call(zoom.event);</code>，這樣一開始才會按照我們設定 zoom 的屬性安排畫面，到這邊，我們已經完成了一個可以縮放，點選也會放大，又可以回歸原本大小的畫面囉！zoom 其實相當的好用，之後會再繼續介紹更多好玩的！ ( 最終完成範例：<a href="/demo/201509/svg-d3-17-zoom-behavior-demo03.html">svg-d3-17-zoom-behavior-demo03.html</a> )</p>
<p><img src="/img/articles/201509/20150915_1_03.gif" alt="SVG D3.js - 縮放行為 ( Zoom Behavior )"></p>
<!-- @@close-->
